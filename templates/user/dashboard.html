{% extends "base.html" %}
{% block content %}

<div class="container mt-5">
  <h2>üëã Welcome, {{ user.Name }}!</h2>
  <p>Trade cryptocurrencies below to grow your portfolio or manage your watchlist.</p>
  <hr>

  <h4>üìà Available Cryptocurrencies</h4>

  {% if cryptos %}
  <table class="table table-striped mt-3">
    <thead class="thead-dark">
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Symbol</th>
        <th>Blockchain</th>
        <th>Launch Date</th>
        <th>Price (USD)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for crypto in cryptos %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ crypto.Name }}</td>
        <td>{{ crypto.Symbol }}</td>
        <td>{{ crypto.BlockchainType or "N/A" }}</td>
        <td>{{ crypto.LaunchDate.strftime("%Y-%m-%d") if crypto.LaunchDate else "N/A" }}</td>
        <td>
          {% if crypto.market_price %}
          ${{ "{:,.2f}".format(crypto.market_price.Price) }}
          {% else %}
          $100.00
          {% endif %}
        </td>
        <td>
          <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#buyModal{{ crypto.CryptoID }}">Buy</button>
          <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#sellModal{{ crypto.CryptoID }}">Sell</button>
          <form action="{{ url_for('user.add_to_watchlist', crypto_id=crypto.CryptoID) }}" method="POST" class="d-inline">
  <button type="submit" class="btn btn-warning btn-sm">‚≠ê Add to Watchlist</button>
</form>

        </td>
      </tr>

      <!-- Buy Modal -->
      <div class="modal fade" id="buyModal{{ crypto.CryptoID }}" tabindex="-1" aria-labelledby="buyModalLabel{{ crypto.CryptoID }}" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form action="{{ url_for('user.buy_crypto', crypto_id=crypto.CryptoID) }}" method="POST" class="trade-form">
              <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Buy {{ crypto.Name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <label>Enter Quantity:</label>
                <input type="number" name="quantity" step="0.01" min="0.01" class="form-control quantity-input"
                       data-price="{{ crypto.market_price.Price if crypto.market_price else 100.00 }}" required>

                <p class="mt-3 mb-0">
                  üí∞ Price: <strong class="price-display">${{ "{:,.2f}".format(crypto.market_price.Price) if crypto.market_price else "100.00" }}</strong><br>
                  Total Cost: <strong class="total-cost text-success">$0.00</strong>
                </p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-success">Confirm Buy</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Sell Modal -->
      <div class="modal fade" id="sellModal{{ crypto.CryptoID }}" tabindex="-1" aria-labelledby="sellModalLabel{{ crypto.CryptoID }}" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form action="{{ url_for('user.sell_crypto', crypto_id=crypto.CryptoID) }}" method="POST" class="trade-form">
              <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Sell {{ crypto.Name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <label>Enter Quantity:</label>
                <input type="number" name="quantity" step="0.01" min="0.01" class="form-control quantity-input"
                       data-price="{{ crypto.market_price.Price if crypto.market_price else 100.00 }}" required>

                <p class="mt-3 mb-0">
                  üí∞ Price: <strong class="price-display">${{ "{:,.2f}".format(crypto.market_price.Price) if crypto.market_price else "100.00" }}</strong><br>
                  Total Proceeds: <strong class="total-cost text-danger">$0.00</strong>
                </p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Confirm Sell</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="text-muted">No cryptocurrencies available.</p>
  {% endif %}
</div>

<!-- JS: Live total calculation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  function updateTotalForInput(input) {
    const modal = input.closest('.modal');
    const totalEl = modal.querySelector('.total-cost');
    const price = parseFloat(input.dataset.price || 0);
    const qty = parseFloat(input.value || 0);
    const total = price * qty;
    totalEl.textContent = `$${total.toFixed(2)}`;
  }

  document.querySelectorAll('.quantity-input').forEach(input => {
    updateTotalForInput(input);
    input.addEventListener('input', () => updateTotalForInput(input));
  });

  document.querySelectorAll('.modal').forEach(modalEl => {
    modalEl.addEventListener('show.bs.modal', () => {
      const input = modalEl.querySelector('.quantity-input');
      if (input) updateTotalForInput(input);
    });
  });
});
</script>

{% endblock %}
